<!DOCTYPE html>
<html lang="uz">

<head>
  <meta charset="UTF-8" />
  <title>Ombor boshqaruvi</title> <!-- jsPDF kutubxonasi (PDF yaratish uchun) -->
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf-autotable/3.5.28/jspdf.plugin.autotable.min.js"></script>
  <link rel="stylesheet" href="style.css">
</head>

<body>
  <h1>ðŸ“¦ Ombor boshqaruvi</h1>
  <form id="product-form"> <input type="hidden" id="edit-index" /> <label>Kod: <input type="text" id="product-code"
        required /></label> <label>Nomi: <input type="text" id="product-name" required /></label> <label>Oâ€˜lcham
      (oâ€˜lchov birlikka qarab): <input type="number" id="product-size" step="0.001" min="0" required /></label>
    <label>Miqdor (dona yoki kg): <input type="number" id="product-quantity" step="0.001" min="0" required /></label>
    <label>Olish narxi (USD): <input type="number" id="product-cost-price-usd" step="0.01" min="0" /></label>
    <label>Sotish narxi (USD): <input type="number" id="product-sale-price-usd" step="0.01" min="0" /></label> <label>$
      kursi: <input type="number" id="dollar-rate" value="12500" min="0" required /></label> <label>Kategoriya: <select
        id="product-category" required>
        <option value="luxury">Luxury</option>
        <option value="donali">Donali</option>
        <option value="pachkali">Pachkali</option>
        <option value="golden_art_floor">Golden Art Floor</option>
        <option value="kiloli">Kiloli</option>
      </select> </label> <button type="submit">âž• Saqlash</button>
  </form>
  <hr /> <label>Kodni qidirish: <input type="text" id="search-code" placeholder="Kod..." /></label> <button
    id="save-sales-pdf">ðŸ“‘ Sotilganlarni PDF saqlash</button> <!-- Har bir kategoriya uchun jadval -->
  <h2>Luxury va boshqa</h2>
  <table>
    <thead>
      <tr>
        <th>Kod</th>
        <th>Nomi</th>
        <th>Miqdor</th>
        <th>Olish narxi</th>
        <th>Sotish narxi</th>
        <th>Amallar</th>
      </tr>
    </thead>
    <tbody id="luxury-table"></tbody>
  </table>
  <h2>Donali</h2>
  <table>
    <thead>
      <tr>
        <th>Kod</th>
        <th>Nomi</th>
        <th>Miqdor</th>
        <th>Olish narxi</th>
        <th>Sotish narxi</th>
        <th>Amallar</th>
      </tr>
    </thead>
    <tbody id="donali-table"></tbody>
  </table>
  <h2>Pachkali</h2>
  <table>
    <thead>
      <tr>
        <th>Kod</th>
        <th>Nomi</th>
        <th>Miqdor</th>
        <th>Olish narxi</th>
        <th>Sotish narxi</th>
        <th>Amallar</th>
      </tr>
    </thead>
    <tbody id="pachkali-table"></tbody>
  </table>
  <h2>Golden Art Floor</h2>
  <table>
    <thead>
      <tr>
        <th>Kod</th>
        <th>Nomi</th>
        <th>Miqdor</th>
        <th>Olish narxi</th>
        <th>Sotish narxi</th>
        <th>Amallar</th>
      </tr>
    </thead>
    <tbody id="golden-art-floor-table"></tbody>
  </table>
  <h2>Kiloli</h2>
  <table>
    <thead>
      <tr>
        <th>Kod</th>
        <th>Nomi</th>
        <th>Miqdor (kg)</th>
        <th>Olish narxi</th>
        <th>Sotish narxi</th>
        <th>Amallar</th>
      </tr>
    </thead>
    <tbody id="kiloli-table"></tbody>
  </table>
  <h3 id="remain-summary"></h3>
  <hr />
  <h2>Sotuv</h2>
  <table>
    <thead>
      <tr>
        <th>Vaqt</th>
        <th>Kod</th>
        <th>Nomi</th>
        <th>Kv.mÂ²</th>
        <th>Miqdor</th>
        <th>Soâ€˜m</th>
        <th>USD</th>
      </tr>
    </thead>
    <tbody id="sales-table"></tbody>
  </table>
  <p>Jami sotilgan: <span id="sold-total"></span></p>
  <script>
    let products = JSON.parse(localStorage.getItem("products") || "[]");
    let sales = JSON.parse(localStorage.getItem("sales") || "[]");
    const EPSILON = 0.0001;

    function saveToLocalStorage() {
      localStorage.setItem("products", JSON.stringify(products));
      localStorage.setItem("sales", JSON.stringify(sales));
    }


    // Format funksiyalar
    function fmtSom(v) {
      return Number(v).toLocaleString("uz-UZ") + " soâ€˜m";
    }

    function fmtUsd(v) {
      return "$" + Number(v).toFixed(2);
    }

    // Dona miqdorini yaxlitlash
    function roundQty(q) {
      const i = Math.floor(q), f = q - i;
      return f >= 0.5 ? Math.ceil(q) : Math.floor(q);
    }

    // Kategoriya boâ€˜yicha jadval ID ni aniqlash
    function getTableIdByCategory(cat) {
      switch (cat) {
        case "donali": return "donali-table";
        case "pachkali": return "pachkali-table";
        case "golden_art_floor": return "golden-art-floor-table";
        case "kiloli": return "kiloli-table";
        default: return "luxury-table";
      }
    }

    // Mahsulotlarni jadvalga chiqarish
    function renderProducts(filter = "") {
      // Hamma jadvallarni tozalash
      ["luxury-table", "donali-table", "pachkali-table", "golden-art-floor-table", "kiloli-table"]
        .forEach(id => document.getElementById(id).innerHTML = "");

      products.forEach((p, i) => {
        if (filter && !p.code.toLowerCase().includes(filter.toLowerCase())) return;

        const tr = document.createElement("tr");
        const qty = Number(p.quantity) || 0;
        const totalArea = Number(p.totalArea) || 0;

        let qtyDisplay = (p.category === "kiloli")
          ? `${qty.toFixed(3)} kg`
          : `${roundQty(qty)} dona (${totalArea.toFixed(3)} mÂ²)`;

        // Amal tugmalari
        let actions = "";

        if (p.category === "kiloli") {
          actions += `<button class="action-btn" onclick="sellByKg(${i})">Kiloda sotish</button>`;
        } else {
          if (!["donali", "pachkali"].includes(p.category)) {
            actions += `<button class="action-btn" onclick="sellByArea(${i})">Kvadrat sotish</button>`;
          }
          actions += `<button class="action-btn" onclick="sellByPiece(${i})">Dona sotish</button>`;
        }

        actions += `
          <button class="action-btn" onclick="editProduct(${i})">Tahrirlash</button>
          <button class="action-btn" onclick="deleteProduct(${i})">Oâ€˜chirish</button>
        `;

        tr.innerHTML = `
          <td>${p.code}</td>
          <td>${p.name}</td>
          <td>${qtyDisplay}</td>
          <td>${fmtSom(p.costSom || 0)} / ${fmtUsd(p.costUsd || 0)}</td>
          <td>${fmtSom(p.saleSom || 0)} / ${fmtUsd(p.saleUsd || 0)}</td>
          <td>${actions}</td>
        `;

        document.getElementById(getTableIdByCategory(p.category)).appendChild(tr);
      });

      renderRemain();
      renderSales();
    }

    // Omborda qolgan mahsulotlar umumiy statistikasi
    function renderRemain() {
      let totalQ = 0, totalArea = 0;

      products.forEach(p => {
        totalQ += Number(p.quantity) || 0;
        totalArea += Number(p.totalArea) || 0;
      });

      document.getElementById("remain-summary").textContent =
        `Omborda qolgan jami: ${totalQ.toFixed(3)} dona / kg, ${totalArea.toFixed(3)} mÂ²`;
    }
    function renderSales() {
      const tbl = document.getElementById("sales-table");
      tbl.innerHTML = "";

      let totalQty = 0;
      let totalArea = 0;
      let totalSom = 0;
      let totalUsd = 0;

      sales.forEach(s => {
        const qty = Number(s.quantity) || 0;
        const som = Number(s.som) || 0;
        const usd = Number(s.usd) || 0;

        // Mahsulotdan o'lchamni topamiz
        const relatedProduct = products.find(p => p.code === s.code);
        const size = relatedProduct?.size || 0;

        // Agar o'lcham 10 dan kichik yoki teng bo'lsa kvadrat metr hisoblanadi
        const area = s.area !== undefined ? s.area : ((size > 0 && size <= 10) ? (qty * size) : 0);

        const tr = document.createElement("tr");
        tr.innerHTML = `
      <td>${new Date(s.date).toLocaleString()}</td>
      <td>${s.code || ""}</td>
      <td>${s.name || ""}</td>
      <td>${area > 0 ? area.toFixed(3) : "-"}</td>
      <td>${qty.toFixed(3)}</td>
      <td>${fmtSom(som)}</td>
      <td>${fmtUsd(usd)}</td>
    `;
        tbl.appendChild(tr);

        totalQty += qty;
        totalArea += area;
        totalSom += som;
        totalUsd += usd;
      });

      document.getElementById("sold-total").textContent =
        `${totalQty.toFixed(3)} dona/kg, ${totalArea.toFixed(3)} mÂ², ${fmtSom(totalSom)}, ${fmtUsd(totalUsd)}`;
    }

    // Mahsulotni tahrirlash
    function editProduct(index) {
      const p = products[index];

      document.getElementById("edit-index").value = index;
      document.getElementById("product-code").value = p.code;
      document.getElementById("product-name").value = p.name;
      document.getElementById("product-size").value = p.size || 0;
      document.getElementById("product-quantity").value = p.quantity || 0;
      document.getElementById("product-cost-price-usd").value = p.costUsd || 0;
      document.getElementById("product-sale-price-usd").value = p.saleUsd || 0;
      document.getElementById("dollar-rate").value = p.dollarRate || 12500;
      document.getElementById("product-category").value = p.category;
    }

    // Mahsulotni oâ€˜chirish
    function deleteProduct(index) {
      if (confirm("Haqiqatan ham ushbu mahsulotni oâ€˜chirmoqchimisiz?")) {
        products.splice(index, 1);
        saveToLocalStorage();
        renderProducts();
      }
    }

    // Formani yuborish (saqlash yoki tahrirlash)
    document.getElementById("product-form").addEventListener("submit", function (e) {
      e.preventDefault();

      const index = document.getElementById("edit-index").value;
      const code = document.getElementById("product-code").value.trim();
      const name = document.getElementById("product-name").value.trim();
      const size = parseFloat(document.getElementById("product-size").value) || 0;
      const quantity = parseFloat(document.getElementById("product-quantity").value) || 0;
      const costUsd = parseFloat(document.getElementById("product-cost-price-usd").value) || 0;
      const saleUsd = parseFloat(document.getElementById("product-sale-price-usd").value) || 0;
      const dollarRate = parseFloat(document.getElementById("dollar-rate").value) || 12500;
      const category = document.getElementById("product-category").value;

      const costSom = costUsd * dollarRate;
      const saleSom = saleUsd * dollarRate;
      const totalArea = size * quantity;

      const productData = {
        code,
        name,
        size,
        quantity,
        costUsd,
        costSom,
        saleUsd,
        saleSom,
        dollarRate,
        category,
        totalArea
      };

      if (index === "") {
        products.push(productData);
      } else {
        products[index] = productData;
      }

      saveToLocalStorage();
      renderProducts();
      this.reset();
      document.getElementById("edit-index").value = "";
    });

    // Kiloda sotish
    function sellByKg(index) {
      const p = products[index];
      const sellQty = parseFloat(prompt(`Necha kg sotilsin? (Mavjud: ${p.quantity.toFixed(3)} kg)`));

      if (isNaN(sellQty) || sellQty <= 0) return alert("Toâ€˜gâ€˜ri kg kiriting.");
      if (sellQty > p.quantity + EPSILON) return alert("Omborda bu miqdorda mahsulot yoâ€˜q.");

      p.quantity -= sellQty;

      if (p.quantity < EPSILON) {
        products.splice(index, 1);
      }

      sales.push({
        date: new Date().toISOString(),
        code: p.code,
        name: p.name,
        quantity: quantityToSell, //kiloli
        som: p.saleSom * quantityToSell,
        usd: p.saleUsd * quantityToSell
      });


      saveToLocalStorage();
      renderProducts();
      renderSales();
    }
    function sellByArea(index) {
      const p = products[index];
      const sellArea = parseFloat(prompt(`Necha kvadrat metr sotilsin? (Mavjud: ${p.totalArea.toFixed(3)} mÂ²)`));

      if (isNaN(sellArea) || sellArea <= 0) return alert("Toâ€˜gâ€˜ri miqdor kiriting.");
      if (sellArea > p.totalArea + EPSILON) return alert("Omborda bu miqdorda mahsulot yoâ€˜q.");

      const sellPricePerM2 = p.saleUsd;  // Sotuv narxi per mÂ² (USD)
      const size = p.size;              // Mahsulot oâ€˜lchami (1 dona necha kvadrat metr)

      // Sotilgan maydonning qiymatini hisoblash (soâ€˜m va USD)
      const som = sellPricePerM2 * sellArea * p.dollarRate;
      const usd = sellPricePerM2 * sellArea;

      // Sotilgan maydonni sotishdan keyin yangilash
      p.totalArea -= sellArea;

      // Maydonni donaga oâ€˜zgartirish (agar maydonni sotgan boâ€˜lsak, unda donalar miqdorini ham yangilaymiz)
      const quantityToSell = sellArea / size;
      p.quantity -= quantityToSell;

      // Sotishdan keyin 0 ga teng boâ€˜lgan miqdorni olib tashlash
      if (p.quantity < EPSILON) {
        p.quantity = 0;
      }
      if (p.totalArea < EPSILON) {
        p.totalArea = 0;
      }

      // Sotishni roâ€˜yxatga qoâ€˜shish
      sales.push({
        date: new Date().toISOString(),
        code: p.code,
        name: p.name,
        area: sellArea,    // Kvadrat metr boâ€˜yicha sotildi
        quantity: quantityToSell,    // Sotilgan dona miqdori
        som: som,
        usd: usd
      });

      saveToLocalStorage();
      renderProducts();
      renderSales();
    }


    function sellByPiece(index) {
      const p = products[index];
      const sellQty = parseInt(prompt(`Necha dona sotilsin? (Mavjud: ${roundQty(p.quantity)} dona)`));

      if (isNaN(sellQty) || sellQty <= 0) return alert("Toâ€˜gâ€˜ri miqdor kiriting.");
      if (sellQty > roundQty(p.quantity)) return alert("Omborda bu miqdorda mahsulot yoâ€˜q.");

      const sellPricePerPiece = p.saleUsd;  // Sotuv narxi per dona (USD)
      const size = p.size;  // Mahsulot oâ€˜lchami (kvadrat metr boâ€˜yicha)

      // Sotilgan donalar qiymatini hisoblash (soâ€˜m va USD)
      const som = sellPricePerPiece * sellQty * p.dollarRate;
      const usd = sellPricePerPiece * sellQty;

      // Sotishdan keyin donalar va maydonni yangilash
      p.quantity -= sellQty;
      p.totalArea -= size * sellQty;

      if (p.quantity < EPSILON) {
        p.quantity = 0;  // Agar dona miqdori 0 ga teng boâ€˜lsa, mahsulotni olib tashlaymiz
      }
      if (p.totalArea < EPSILON) {
        p.totalArea = 0;
      }

      // Sotishni roâ€˜yxatga qoâ€˜shish
      sales.push({
        date: new Date().toISOString(),
        code: p.code,
        name: p.name,
        area: 0,           // Sotilgan maydon 0 (dona sotildi)
        quantity: sellQty, // Sotilgan dona miqdori
        som: som,
        usd: usd
      });

      saveToLocalStorage();
      renderProducts();
      renderSales();
    }




    document.getElementById("search-code").addEventListener("input", function () {
      renderProducts(this.value.trim());
    });


    document.getElementById("save-sales-pdf").addEventListener("click", function () {
      const { jsPDF } = window.jspdf;
      const doc = new jsPDF();

      doc.text("Sotilgan mahsulotlar ro'yxati", 14, 15);

      const columns = ["Vaqt", "Kod", "Nomi", "Miqdor", "Kv.mÂ²", "So'm", "USD"];

      let totalQty = 0;
      let totalArea = 0;
      let totalSom = 0;
      let totalUsd = 0;

      const rows = sales.map(s => {
        const qty = Number(s.quantity) || 0;
        const som = Number(s.som) || 0;
        const usd = Number(s.usd) || 0;

        totalQty += qty;
        totalSom += som;
        totalUsd += usd;

        const relatedProduct = products.find(p => p.code === s.code);
        const size = relatedProduct?.size || 0;
        const area = (size > 0 && size <= 10) ? (qty * size) : 0;

        totalArea += area;

        return [
          new Date(s.date).toLocaleString(),
          s.code,
          s.name,
          qty.toFixed(3),
          area ? area.toFixed(3) : "-",
          fmtSom(som),
          fmtUsd(usd)
        ];
      });

      doc.autoTable({
        head: [columns],
        body: rows,
        startY: 20,
        styles: { fontSize: 8 },
      });

      doc.setFontSize(10);
      doc.text(`Umumiy miqdor: ${totalQty.toFixed(3)} dona/kg`, 14, doc.lastAutoTable.finalY + 10);
      doc.text(`Umumiy kvadrat metr: ${totalArea.toFixed(3)} mÂ²`, 14, doc.lastAutoTable.finalY + 16);
      doc.text(`Umumiy summa: ${fmtSom(totalSom)} / ${fmtUsd(totalUsd)}`, 14, doc.lastAutoTable.finalY + 22);

      doc.save("sotilganlar.pdf");
    });

    renderProducts();
    renderSales();
  </script>
</body>

</html>