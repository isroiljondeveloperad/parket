<!DOCTYPE html>
<html lang="uz">

<head>
  <meta charset="UTF-8" />
  <title>Ombor boshqaruvi</title>
  <!-- jsPDF + AutoTable -->
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf-autotable/3.5.28/jspdf.plugin.autotable.min.js"></script>
  <link rel="stylesheet" href="style.css" />
</head>

<body>
  <h1>ðŸ“¦ Ombor boshqaruvi</h1>

  <form id="product-form">
    <input type="hidden" id="edit-index" />
    <label>Kod: <input type="text" id="product-code" required /></label>
    <label>Nomi: <input type="text" id="product-name" required /></label>
    <label>Oâ€˜lcham (mÂ²): <input type="number" id="product-size" step="0.001" min="0" required /></label>
    <label>Miqdor (dona): <input type="number" id="product-quantity" step="0.001" min="0" required /></label>
    <label>Olish narxi (USD): <input type="number" id="product-cost-price-usd" step="0.01" min="0" /></label>
    <label>Sotish narxi (USD): <input type="number" id="product-sale-price-usd" step="0.01" min="0" /></label>
    <label>$ kursi: <input type="number" id="dollar-rate" value="12500" min="0" required /></label>
    <label>Kategoriya:
      <select id="product-category" required>
        <option value="luxury">Luxury</option>
        <option value="golden_art_floor">Golden Art Floor</option>
      </select>
    </label>
    <button type="submit">âž• Saqlash</button>
  </form>

  <hr />

  <label>Kodni qidirish: <input type="text" id="search-code" placeholder="Kod..." /></label>
  <button id="save-pdf">ðŸ“‘ PDF saqlash (har kunlik)</button>

  <h2>Luxury</h2>
  <table>
    <thead>
      <tr>
        <th>Kod</th>
        <th>Nomi</th>
        <th>Miqdor</th>
        <th>Olish narxi</th>
        <th>Sotish narxi</th>
        <th>Amallar</th>
      </tr>
    </thead>
    <tbody id="luxury-table"></tbody>
  </table>

  <h2>Golden Art Floor</h2>
  <table>
    <thead>
      <tr>
        <th>Kod</th>
        <th>Nomi</th>
        <th>Miqdor</th>
        <th>Olish narxi</th>
        <th>Sotish narxi</th>
        <th>Amallar</th>
      </tr>
    </thead>
    <tbody id="golden-art-floor-table"></tbody>
  </table>

  <h3 id="remain-summary"></h3>
  <h3 id="sales-summary"></h3>

  <hr />
  <h2>Sotuv</h2>
  <table>
    <thead>
      <tr>
        <th>Vaqt</th>
        <th>Kod</th>
        <th>Nomi</th>
        <th>Sold Piece</th>
        <th>Maydon (mÂ²)</th>
        <th>Summa Soâ€˜m</th>
        <th>Summa USD</th>
      </tr>
    </thead>
    <tbody id="sales-table"></tbody>
  </table>

  <script>
    let products = JSON.parse(localStorage.getItem("products") || "[]"),
      sales = JSON.parse(localStorage.getItem("sales") || "[]");

    function fmtSom(v) {
      return Math.round(v).toLocaleString("uz-UZ").replace(/,/g, " ") + " soâ€˜m";
    }

    function fmtUsd(v) {
      if (v % 1 === 0) {
        return "$" + v.toFixed(0);
      } else {
        return "$" + v.toFixed(2);
      }
    }

    function roundQty(q) {
      const i = Math.floor(q),
        f = q - i;
      return f >= 0.5 ? Math.ceil(q) : Math.floor(q);
    }

    function getTableIdByCategory(cat) {
      return cat === "golden_art_floor" ? "golden-art-floor-table" : "luxury-table";
    }

    function renderProducts(filter = "") {
      ["luxury-table", "golden-art-floor-table"].forEach(id => document.getElementById(id).innerHTML = "");
      products.forEach((p, i) => {
        if (filter && !p.code.toLowerCase().includes(filter.toLowerCase())) return;
        const tr = document.createElement("tr");
        const qtyDisplay = roundQty(p.quantity) + " dona (" + (p.totalArea || 0).toFixed(3) + " mÂ²)";
        tr.innerHTML = `
          <td>${p.code}</td><td>${p.name}</td><td>${qtyDisplay}</td>
          <td>${fmtSom(p.costSom)} / ${fmtUsd(p.costUsd)}</td>
          <td>${fmtSom(p.saleSom)} / ${fmtUsd(p.saleUsd)}</td>
          <td>
            <button onclick="sellByPiece(${i})">Dona sotish</button>
            <button onclick="sellByArea(${i})">Kvadrat sotish</button>
            <button onclick="editProduct(${i})">Tahrirlash</button>
            <button onclick="deleteProduct(${i})">Oâ€˜chirish</button>
          </td>`;
        document.getElementById(getTableIdByCategory(p.category)).appendChild(tr);
      });
      renderRemain();
      renderSales();
    }

    function renderRemain() {
      let tq = 0, ta = 0;
      products.forEach(p => {
        tq += p.quantity;
        ta += p.totalArea || 0;
      });
      document.getElementById("remain-summary").textContent = `ðŸ§¾ Omborda: ${tq.toFixed(2)} dona, ${ta.toFixed(2)} mÂ²`;
    }

    function renderSales() {
      const tbl = document.getElementById("sales-table");
      tbl.innerHTML = "";
      let tq = 0, ta = 0, som = 0, usd = 0;

      sales.forEach(s => {
        const tr = document.createElement("tr");
        const roundedQty = roundQty(s.qty);
        tr.innerHTML = `
          <td>${s.time}</td>
          <td>${s.code || ""}</td>
          <td>${s.name}</td>
          <td>${roundedQty} dona (${s.area ? s.area.toFixed(3) : "0.000"} mÂ²)</td>
          <td>${s.area ? s.area.toFixed(3) : "0.000"} mÂ²</td>
          <td>${fmtSom(s.sumSom)}</td>
          <td>${fmtUsd(s.sumUsd)}</td>
        `;
        tbl.appendChild(tr);
        tq += roundedQty;
        ta += s.area || 0;
        som += s.sumSom;
        usd += s.sumUsd;
      });

      document.getElementById("sales-summary").textContent =
        `ðŸ“ˆ Jami sotuv: ${tq} dona, ${ta.toFixed(3)} mÂ², ${fmtSom(som)}, ${fmtUsd(usd)}`;
    }

    function addSale(code, name, qty, area, sumSom, sumUsd) {
      sales.push({ time: new Date().toLocaleString(), code, name, qty, area, sumSom, sumUsd });
      localStorage.setItem("sales", JSON.stringify(sales));
    }

    function sellByPiece(idx) {
      const p = products[idx];
      const qty = parseFloat(prompt("Nechta dona sotiladi?", "1"));
      if (!qty || qty <= 0 || qty > p.quantity) {
        return alert("Notoâ€˜gâ€˜ri miqdor!");
      }

      // maydon hisoblanadi dona Ã— 1 dona maydoni
      const area = qty * p.size;

      // 1 kvadrat narxi = p.saleUsd (sen shu tarzda saqlagan boâ€˜lsang)
      const usd = p.saleUsd * area;
      const som = p.saleSom * area;

      p.quantity -= qty;
      p.totalArea -= area;

      if (p.quantity <= 0 || p.totalArea <= 0) {
        products.splice(idx, 1);
      }

      addSale(p.code, p.name, qty, area, som, usd);
      localStorage.setItem("products", JSON.stringify(products));
      renderProducts();
    }

    function sellByArea(idx) {
      const p = products[idx];
      const areaToSell = parseFloat(prompt("Necha mÂ² sotiladi?", "1"));
      if (!areaToSell || areaToSell <= 0) {
        return alert("Notoâ€˜gâ€˜ri maydon!");
      }
      if (areaToSell > p.totalArea) {
        return alert("Sotiladigan maydon ombordagi maydondan katta boÊ»la olmaydi!");
      }

      const qtySold = areaToSell / p.size;

      // 1 kvadrat narxi = p.saleUsd
      const usd = p.saleUsd * areaToSell;
      const som = p.saleSom * areaToSell;

      p.quantity -= qtySold;
      p.totalArea -= areaToSell;

      if (p.quantity <= 0 || p.totalArea <= 0) {
        products.splice(idx, 1);
      }

      addSale(p.code, p.name, qtySold, areaToSell, som, usd);
      localStorage.setItem("products", JSON.stringify(products));
      renderProducts();
    }

    function editProduct(idx) {
      const p = products[idx];
      document.getElementById("edit-index").value = idx;
      document.getElementById("product-code").value = p.code;
      document.getElementById("product-name").value = p.name;
      document.getElementById("product-size").value = p.size;
      document.getElementById("product-quantity").value = p.quantity;
      document.getElementById("product-cost-price-usd").value = p.costUsd;
      document.getElementById("product-sale-price-usd").value = p.saleUsd;
      document.getElementById("dollar-rate").value = p.dollarRate;
      document.getElementById("product-category").value = p.category;
    }

    function deleteProduct(idx) {
      if (confirm("Oâ€˜chirishga ishonchingiz komilmi?")) {
        products.splice(idx, 1);
        localStorage.setItem("products", JSON.stringify(products));
        renderProducts();
      }
    }

    document.getElementById("product-form").addEventListener("submit", function (e) {
      e.preventDefault();
      const idx = document.getElementById("edit-index").value;
      const pd = {
        code: document.getElementById("product-code").value.trim(),
        name: document.getElementById("product-name").value.trim(),
        size: parseFloat(document.getElementById("product-size").value),
        quantity: parseFloat(document.getElementById("product-quantity").value),
        costUsd: parseFloat(document.getElementById("product-cost-price-usd").value) || 0,
        saleUsd: parseFloat(document.getElementById("product-sale-price-usd").value) || 0,
        dollarRate: parseFloat(document.getElementById("dollar-rate").value),
        category: document.getElementById("product-category").value
      };
      pd.costSom = pd.costUsd * pd.dollarRate;
      pd.saleSom = pd.saleUsd * pd.dollarRate;
      pd.totalArea = pd.quantity * pd.size;

      if (idx !== "") products[idx] = pd;
      else products.push(pd);

      localStorage.setItem("products", JSON.stringify(products));
      this.reset();
      document.getElementById("edit-index").value = "";
      renderProducts();
    });

    document.getElementById("search-code").addEventListener("input", e => {
      renderProducts(e.target.value.trim());
    });

    document.getElementById("save-pdf").addEventListener("click", () => {
      if (sales.length === 0) {
        alert("Sotilgan mahsulotlar yoâ€˜q!");
        return;
      }
      const { jsPDF } = window.jspdf;
      const doc = new jsPDF();
      doc.setFontSize(14);
      doc.text(`ðŸ“¦ Sotuvlar hisobot (${new Date().toLocaleDateString()})`, 10, 10);

      const head = [[
        "Sana", "Kod", "Mahsulot nomi", "Sold (dona)", "Maydon (mÂ²)", "Summa USD", "Summa So'm"
      ]];
      const body = sales.map(s => {
        const roundedQty = roundQty(s.qty);
        return [
          s.time,
          s.code || "",
          s.name,
          roundedQty.toString(),
          (s.area ? s.area.toFixed(3) : "0.000"),
          fmtUsd(s.sumUsd),
          fmtSom(s.sumSom)
        ];
      });

      doc.autoTable({
        head: head,
        body: body,
        startY: 20,
        styles: { fontSize: 10 },
        headStyles: { fillColor: [220, 220, 220] }
      });

      let jamiDona = 0, jamiKvadrat = 0, jamiUsd = 0, jamiSom = 0;
      sales.forEach(s => {
        jamiDona += roundQty(s.qty);
        jamiKvadrat += s.area || 0;
        jamiUsd += s.sumUsd;
        jamiSom += s.sumSom;
      });

      const finalY = doc.previousAutoTable
        ? doc.previousAutoTable.finalY + 10
        : doc.lastAutoTable
          ? doc.lastAutoTable.finalY + 10
          : 20 + body.length * 7 + 20;

      doc.setFontSize(12);
      doc.text(`Jami: ${jamiDona} dona, ${jamiKvadrat.toFixed(3)} mÂ², ${fmtUsd(jamiUsd)}, ${fmtSom(jamiSom)}`, 10, finalY);

      const filename = `sotuvlar_${new Date().toISOString().split('T')[0]}.pdf`;
      doc.save(filename);
    });

    renderProducts();
  </script>
</body>

</html>